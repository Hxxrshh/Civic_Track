<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find Nearby Care - MediTriage</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f8fafc;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        
        header {
            background-color: #ffffff;
            color: #333;
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-bottom: 1px solid #edf2f7;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
        }
        
        .logo-icon {
            color: #4263eb;
            font-size: 1.5rem;
            margin-right: 0.5rem;
            padding: 0.25rem;
            border: 2px solid #4263eb;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 35px;
            height: 35px;
        }
        
        .logo-text {
            color: #4263eb;
            font-size: 1.4rem;
            font-weight: 600;
            text-decoration: none;
        }
        
        .nav-menu {
            display: flex;
            align-items: center;
        }
        
        .nav-link {
            text-decoration: none;
            padding: 0.5rem 1rem;
            color: #4a5568;
            border-radius: 4px;
            margin: 0 0.25rem;
            transition: background-color 0.2s;
        }
        
        .nav-link:hover {
            background-color: #f7fafc;
            color: #3182ce;
        }
        
        .nav-link.active {
            background-color: #ebf4ff;
            color: #3182ce;
            font-weight: 500;
        }
        
        .logout-btn {
            background-color: #f56565;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        .logout-btn:hover {
            background-color: #e53e3e;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .welcome-banner {
            background-color: #f8fafc;
            padding: 1.5rem 0;
            margin-bottom: 1.5rem;
        }
        
        .welcome-title {
            color: #364fc7;
            font-size: 1.75rem;
            margin-bottom: 0.5rem;
        }
        
        /* Map Layout */
        .map-layout {
            display: flex;
            gap: 2rem;
            margin-top: 1.5rem;
        }
        
        .sidebar {
            flex: 0 0 350px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 1.25rem;
            border-bottom: 1px solid #edf2f7;
        }
        
        .sidebar-search {
            padding: 1.25rem;
            border-bottom: 1px solid #edf2f7;
        }
        
        .search-form {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .search-form label {
            font-weight: 500;
            color: #4a5568;
            font-size: 0.875rem;
        }
        
        .search-form input, .search-form select {
            padding: 0.625rem;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        .search-form button {
            background-color: #4263eb;
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 0.5rem;
        }
        
        .search-form button:hover {
            background-color: #364fc7;
        }
        
        .location-options {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        
        .location-option {
            flex: 1;
            text-align: center;
            padding: 0.5rem;
            background-color: #edf2f7;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            color: #4a5568;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .location-option:hover {
            background-color: #e2e8f0;
        }
        
        .locations-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .location-card {
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #edf2f7;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .location-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .location-card.active {
            border-color: #4263eb;
        }
        
        .location-type {
            font-size: 0.75rem;
            font-weight: 600;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        
        .location-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #2d3748;
        }
        
        .location-address {
            font-size: 0.875rem;
            color: #4a5568;
            margin-bottom: 0.75rem;
        }
        
        .location-details {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        .location-tag {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            background-color: #ebf4ff;
            color: #4263eb;
            border-radius: 4px;
        }
        
        .location-contact {
            font-size: 0.875rem;
            color: #4a5568;
        }
        
        .map-container {
            flex: 1;
            min-height: 600px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .location-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
        }
        
        .location-action {
            padding: 0.5rem 0.75rem;
            background-color: #edf2f7;
            border-radius: 4px;
            font-size: 0.75rem;
            color: #4263eb;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            transition: background-color 0.2s;
        }
        
        .location-action:hover {
            background-color: #e2e8f0;
        }
        
        .location-action i {
            font-size: 1rem;
        }
        
        .loading {
            padding: 2rem;
            text-align: center;
            color: #4a5568;
        }
        
        .loading-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border-left-color: #4263eb;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            .map-layout {
                flex-direction: column;
            }
            
            .sidebar {
                flex: 0 0 auto;
                margin-bottom: 1.5rem;
            }
            
            .map-container {
                height: 400px;
            }
        }
        
        @media (max-width: 768px) {
            .nav-menu {
                display: none;
            }
            
            header {
                padding: 0.75rem 1rem;
            }
            
            .container {
                padding: 1rem;
            }
        }
        
        .city-chips {
            margin-top: 15px;
        }
        
        .chips-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .city-chip {
            background-color: #edf2f7;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.85rem;
            color: #4a5568;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .city-chip:hover {
            background-color: #e2e8f0;
            color: #4263eb;
        }
        
        .city-chip.active {
            background-color: #ebf4ff;
            color: #4263eb;
            border: 1px solid #4263eb;
        }
        
        .current-location-info {
            background-color: #ebf8ff;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 3px solid #4263eb;
        }
        
        .welcome-message {
            text-align: center;
            padding: 20px 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        
        .welcome-message h3 {
            color: #2d3748;
            margin-bottom: 10px;
        }
        
        .welcome-message p {
            color: #4a5568;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <header>
        <a href="../patient-dashboard.html" class="logo-container" style="text-decoration: none;">
            <div class="logo-icon">+</div>
            <span class="logo-text">MediTriage</span>
        </a>
        <div class="nav-menu">
            <a href="../patient-dashboard.html" class="nav-link">Dashboard</a>
            <a href="symptom-intake.html" class="nav-link">Symptom Intake</a>
            <a href="find-nearby-care.html" class="nav-link active">Find Nearby Care</a>
            <a href="my-prescriptions.html" class="nav-link">My Prescriptions</a>
            <button id="logout-btn" class="logout-btn">Logout</button>
        </div>
    </header>
    
    <div class="welcome-banner">
        <div class="container">
            <h1 class="welcome-title">Find Nearby Care</h1>
        </div>
    </div>
    
    <div class="container">
        <div class="map-layout">
            <div class="sidebar">
                <div class="sidebar-header">
                    <h2>Healthcare Facilities</h2>
                    <p>Find hospitals and clinics near you</p>
                </div>
                
                <div class="sidebar-search">
                    <form class="search-form" id="search-form">
                        <div>
                            <label for="location-input">City or Postal Code</label>
                            <input type="text" id="location-input" placeholder="Enter city or postal code in India" required>
                        </div>
                        
                        <div>
                            <label for="search-radius">Search Radius (km)</label>
                            <select id="search-radius">
                                <option value="1">1 km</option>
                                <option value="2">2 km</option>
                                <option value="5" selected>5 km</option>
                                <option value="10">10 km</option>
                                <option value="20">20 km</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="facility-type">Facility Type</label>
                            <select id="facility-type">
                                <option value="all">All Healthcare Facilities</option>
                                <option value="hospital">Hospitals Only</option>
                                <option value="clinic">Clinics Only</option>
                                <option value="pharmacy">Pharmacies Only</option>
                                <option value="doctor">Doctor's Offices</option>
                            </select>
                        </div>
                        
                        <button type="submit">Search</button>
                    </form>
                    
                    <div class="city-chips">
                        <p style="margin-top: 15px; margin-bottom: 8px; font-weight: 500; color: #4a5568;">Popular Cities:</p>
                        <div class="chips-container">
                            <span class="city-chip" onclick="selectCity('Mumbai')">Mumbai</span>
                            <span class="city-chip" onclick="selectCity('Delhi')">Delhi</span>
                            <span class="city-chip" onclick="selectCity('Bangalore')">Bangalore</span>
                            <span class="city-chip" onclick="selectCity('Chennai')">Chennai</span>
                            <span class="city-chip" onclick="selectCity('Kolkata')">Kolkata</span>
                            <span class="city-chip" onclick="selectCity('Hyderabad')">Hyderabad</span>
                            <span class="city-chip" onclick="selectCity('Ahmedabad')">Ahmedabad</span>
                            <span class="city-chip" onclick="selectCity('Pune')">Pune</span>
                        </div>
                    </div>
                </div>
                
                <div class="locations-list" id="locations-list">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Finding healthcare facilities near you...</p>
                    </div>
                </div>
            </div>
            
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>
    
    <!-- Modal for address search -->
    <div id="address-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 1000;">
        <div class="modal-content" style="background-color: white; margin: 15% auto; padding: 20px; border-radius: 8px; max-width: 500px; position: relative;">
            <span class="close" style="position: absolute; right: 15px; top: 10px; font-size: 24px; cursor: pointer;">&times;</span>
            <h2 style="margin-bottom: 15px;">Enter Address</h2>
            <input type="text" id="address-input" style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Enter address, city, or postal code">
            <button id="search-address-btn" style="background-color: #4263eb; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer;">Search</button>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Global variables
        let map;
        let userMarker;
        let facilityMarkers = [];
        let userPosition = null;
        const modal = document.getElementById('address-modal');
        
        // Initialize map when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            setupEventListeners();
            checkAuthentication();
        });
        
        // Check user authentication
        function checkAuthentication() {
            fetch('/api/user', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Not authenticated');
                }
                return response.json();
            })
            .then(data => {
                if (!data.success || data.userType !== 'patient') {
                    throw new Error('Not authorized as patient');
                }
                
                // Show welcome message when page loads
                document.getElementById('locations-list').innerHTML = `
                    <div class="welcome-message">
                        <h3>Find Healthcare Facilities in India</h3>
                        <p>Enter a city or postal code to find hospitals, clinics, and pharmacies near you.</p>
                        <p>Or click on one of the popular cities above to start searching.</p>
                    </div>
                `;
            })
            .catch(error => {
                console.error('Authentication error:', error);
                window.location.href = '../index.html';
            });
        }
        
        // Initialize the map
        function initMap() {
            // Start with India as the default center view (proper coordinates for India)
            map = L.map('map').setView([20.5937, 78.9629], 5); 
            
            // Use Carto basemap which provides better multilingual support with English labels
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ¬© <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
            
            // Add scale control
            L.control.scale({imperial: false, metric: true}).addTo(map);
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Search form submission
            document.getElementById('search-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const location = document.getElementById('location-input').value.trim();
                if (location) {
                    searchLocationInIndia(location);
                } else {
                    alert('Please enter a city or postal code');
                }
            });
            
            // Logout button
            document.getElementById('logout-btn').addEventListener('click', function() {
                fetch('/api/logout', {
                    method: 'POST',
                    credentials: 'include'
                })
                .then(() => {
                    window.location.href = '../index.html';
                })
                .catch(error => {
                    console.error('Logout error:', error);
                    window.location.href = '../index.html';
                });
            });
        }
        
        // Add this function to select popular cities
        function selectCity(cityName) {
            // Highlight the selected city chip
            document.querySelectorAll('.city-chip').forEach(chip => {
                chip.classList.remove('active');
                if (chip.textContent === cityName) {
                    chip.classList.add('active');
                }
            });
            
            document.getElementById('location-input').value = cityName;
            searchLocationInIndia(cityName);
        }
        
        // Add this function to search locations in India
        function searchLocationInIndia(location) {
            document.getElementById('locations-list').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Finding location in India...</p>
                </div>
            `;
            
            // Add "India" to the search query if not already specified
            if (!location.toLowerCase().includes('india')) {
                location += ', India';
            }
            
            // Use countrycodes parameter to prioritize India results
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}&countrycodes=in&accept-language=en&limit=1`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        userPosition = {
                            latitude: parseFloat(data[0].lat),
                            longitude: parseFloat(data[0].lon)
                        };
                        
                        console.log("Found location:", data[0].display_name);
                        console.log("Coordinates:", userPosition);
                        
                        // Update UI with location name
                        const locationName = data[0].display_name.split(',')[0];
                        document.getElementById('locations-list').innerHTML = `
                            <div class="current-location-info">
                                <p><strong>Searching near:</strong> ${locationName}, India</p>
                            </div>
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                <p>Finding healthcare facilities...</p>
                            </div>
                        `;
                        
                        updateUserMarker();
                        searchFacilities();
                    } else {
                        document.getElementById('locations-list').innerHTML = `
                            <div style="padding: 20px; text-align: center;">
                                <p>Sorry, we couldn't find that location in India.</p>
                                <p>Please try a more specific city name or postal code.</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Geocoding error:', error);
                    document.getElementById('locations-list').innerHTML = `
                        <div style="padding: 20px; text-align: center;">
                            <p>Error finding the location.</p>
                            <p>Please try a different city or postal code.</p>
                        </div>
                    `;
                });
        }
        
        // Update the search address function to prioritize results in India
        function searchAddressGeocode(address) {
            document.getElementById('locations-list').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Finding this address...</p>
                </div>
            `;
            
            // Add "India" to the search query if not already specified
            if (!address.toLowerCase().includes('india')) {
                address += ', India';
            }
            
            // Use countrycodes parameter to prioritize India results
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=in&accept-language=en`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        userPosition = {
                            latitude: parseFloat(data[0].lat),
                            longitude: parseFloat(data[0].lon)
                        };
                        
                        console.log("Geocoded location:", userPosition);
                        updateUserMarker();
                        searchFacilities();
                    } else {
                        document.getElementById('locations-list').innerHTML = `
                            <div style="padding: 20px; text-align: center;">
                                <p>Sorry, we couldn't find that address in India.</p>
                                <p>Please try a more specific address with city and state.</p>
                                <button id="try-again" style="background-color: #4263eb; color: white; border: none; padding: 8px 15px; border-radius: 4px; margin-top: 10px; cursor: pointer;">Try Again</button>
                            </div>
                        `;
                        
                        document.getElementById('try-again').addEventListener('click', function() {
                            modal.style.display = 'block';
                        });
                    }
                })
                .catch(error => {
                    console.error('Geocoding error:', error);
                    document.getElementById('locations-list').innerHTML = `
                        <div style="padding: 20px; text-align: center;">
                            <p>Error finding the address.</p>
                            <p>Please try again with a different address format.</p>
                            <button id="try-again" style="background-color: #4263eb; color: white; border: none; padding: 8px 15px; border-radius: 4px; margin-top: 10px; cursor: pointer;">Try Again</button>
                        </div>
                    `;
                    
                    document.getElementById('try-again').addEventListener('click', function() {
                        modal.style.display = 'block';
                    });
                });
        }
        
        // Update user marker on map
        function updateUserMarker() {
            // Remove existing marker if any
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            
            // Set map view to user location
            map.setView([userPosition.latitude, userPosition.longitude], 14);
            
            // Create a custom icon for the user
            const userIcon = L.divIcon({
                className: 'user-marker',
                html: `<div style="background-color: #4263eb; border: 2px solid white; border-radius: 50%; width: 16px; height: 16px; box-shadow: 0 0 0 2px rgba(66, 99, 235, 0.4);"></div>`,
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });
            
            // Add user marker
            userMarker = L.marker([userPosition.latitude, userPosition.longitude], {
                icon: userIcon
            }).addTo(map);
            
            // Add a circle to indicate search radius
            const radiusInKm = parseFloat(document.getElementById('search-radius').value);
            L.circle([userPosition.latitude, userPosition.longitude], {
                radius: radiusInKm * 1000, // Convert km to meters
                color: '#4263eb',
                fillColor: '#4263eb',
                fillOpacity: 0.1,
                weight: 1
            }).addTo(map);
        }
        
        // Search for healthcare facilities
        function searchFacilities() {
            // Clear existing markers
            clearFacilityMarkers();
            
            document.getElementById('locations-list').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Finding healthcare facilities...</p>
                </div>
            `;
            
            const radius = document.getElementById('search-radius').value;
            const facilityType = document.getElementById('facility-type').value;
            
            // Create Overpass API query
            let query = `
                [out:json];
                (
            `;
            
            // Add different facility types based on filter
            if (facilityType === 'all' || facilityType === 'hospital') {
                query += `
                    node["amenity"="hospital"](around:${radius * 1000},${userPosition.latitude},${userPosition.longitude});
                    way["amenity"="hospital"](around:${radius * 1000},${userPosition.latitude},${userPosition.longitude});
                    relation["amenity"="hospital"](around:${radius * 1000},${userPosition.latitude},${userPosition.longitude});
                `;
            }
            
            if (facilityType === 'all' || facilityType === 'clinic') {
                query += `
                    node["amenity"="clinic"](around:${radius * 1000},${userPosition.latitude},${userPosition.longitude});
                    way["amenity"="clinic"](around:${radius * 1000},${userPosition.latitude},${userPosition.longitude});
                    relation["amenity"="clinic"](around:${radius * 1000},${userPosition.latitude},${userPosition.longitude});
                `;
            }
            
            if (facilityType === 'all' || facilityType === 'pharmacy') {
                query += `
                    node["amenity"="pharmacy"](around:${radius * 1000},${userPosition.latitude},${userPosition.longitude});
                    way["amenity"="pharmacy"](around:${radius * 1000},${userPosition.latitude},${userPosition.longitude});
                    relation["amenity"="pharmacy"](around:${radius * 1000},${userPosition.latitude},${userPosition.longitude});
                `;
            }
            
            if (facilityType === 'all' || facilityType === 'doctor') {
                query += `
                    node["healthcare"="doctor"](around:${radius * 1000},${userPosition.latitude},${userPosition.longitude});
                    way["healthcare"="doctor"](around:${radius * 1000},${userPosition.latitude},${userPosition.longitude});
                    relation["healthcare"="doctor"](around:${radius * 1000},${userPosition.latitude},${userPosition.longitude});
                `;
            }
            
            query += `
                );
                out center;
            `;
            
            // Make Overpass API request
            fetch('https://overpass-api.de/api/interpreter', {
                method: 'POST',
                body: query
            })
            .then(response => response.json())
            .then(data => {
                processFacilities(data.elements);
            })
            .catch(error => {
                console.error('Overpass API error:', error);
                document.getElementById('locations-list').innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <p>Error finding healthcare facilities.</p>
                        <p>Please try again or change search parameters.</p>
                        <button onclick="searchFacilities()" style="background-color: #4263eb; color: white; border: none; padding: 8px 15px; border-radius: 4px; margin-top: 10px; cursor: pointer;">Try Again</button>
                    </div>
                `;
            });
        }
        
        // Process facilities data from Overpass API
        function processFacilities(facilities) {
            if (facilities.length === 0) {
                document.getElementById('locations-list').innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <p>No healthcare facilities found in this area.</p>
                        <p>Try increasing the search radius or changing location.</p>
                    </div>
                `;
                return;
            }
            
            // Sort facilities by distance from user
            facilities.sort((a, b) => {
                const aLat = a.lat || a.center?.lat;
                const aLon = a.lon || a.center?.lon;
                const bLat = b.lat || b.center?.lat;
                const bLon = b.lon || b.center?.lon;
                
                if (!aLat || !aLon || !bLat || !bLon) return 0;
                
                const distA = distance(
                    userPosition.latitude, 
                    userPosition.longitude, 
                    aLat, 
                    aLon
                );
                
                const distB = distance(
                    userPosition.latitude, 
                    userPosition.longitude, 
                    bLat, 
                    bLon
                );
                
                return distA - distB;
            });
            
            // Generate HTML for facility list
            let html = '';
            let validFacilities = [];
            
            facilities.forEach(facility => {
                // Skip if no tags
                if (!facility.tags) return;
                
                // Get coordinates
                const lat = facility.lat || facility.center?.lat;
                const lon = facility.lon || facility.center?.lon;
                if (!lat || !lon) return;
                
                // Get facility details
                const name = facility.tags.name || getFacilityTypeText(facility.tags);
                const type = getFacilityTypeText(facility.tags);
                const address = formatAddress(facility.tags);
                
                // Get distance from user
                const dist = distance(userPosition.latitude, userPosition.longitude, lat, lon);
                
                // Store valid facility
                validFacilities.push({
                    id: facility.id,
                    name,
                    type,
                    address,
                    lat,
                    lon,
                    distance: dist,
                    phone: facility.tags.phone || facility.tags['contact:phone'] || 'Not available',
                    website: facility.tags.website || facility.tags['contact:website'] || null,
                    wheelchair: facility.tags.wheelchair || null,
                    emergency: facility.tags.emergency || null,
                    opening_hours: facility.tags.opening_hours || null
                });
                
                // Add marker to map
                addFacilityMarker(lat, lon, name, type, facility.id);
            });
            
            // Limit to 25 results for performance
            validFacilities = validFacilities.slice(0, 25);
            
            // Generate list HTML
            validFacilities.forEach(facility => {
                const formattedDistance = facility.distance < 1 
                    ? `${Math.round(facility.distance * 1000)} m` 
                    : `${facility.distance.toFixed(1)} km`;
                    
                html += `
                    <div class="location-card" data-id="${facility.id}" onclick="highlightFacility(${facility.id})">
                        <div class="location-type">${facility.type}</div>
                        <h3 class="location-name">${facility.name}</h3>
                        <p class="location-address">${facility.address}</p>
                        
                        <div class="location-details">
                            <span class="location-tag">${formattedDistance}</span>
                            ${facility.wheelchair ? `<span class="location-tag">‚ôø Wheelchair Access</span>` : ''}
                            ${facility.emergency === 'yes' ? `<span class="location-tag">üö® Emergency</span>` : ''}
                        </div>
                        
                        <p class="location-contact">
                            <strong>Phone:</strong> ${facility.phone}
                            ${facility.opening_hours ? `<br><strong>Hours:</strong> ${facility.opening_hours}` : ''}
                        </p>
                        
                        <div class="location-actions">
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${facility.lat},${facility.lon}" target="_blank" class="location-action">
                                <i>üó∫Ô∏è</i> Directions
                            </a>
                            ${facility.website ? 
                                `<a href="${facility.website}" target="_blank" class="location-action">
                                    <i>üåê</i> Website
                                </a>` 
                                : ''
                            }
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('locations-list').innerHTML = html;
        }
        
        // Helper function: Calculate distance between two coordinates in kilometers
        function distance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the earth in km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1); 
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2); 
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            const d = R * c; // Distance in km
            return d;
        }
        
        function deg2rad(deg) {
            return deg * (Math.PI/180);
        }
        
        // Format facility address
        function formatAddress(tags) {
            let addressParts = [];
            
            // Try formatted address if available
            if (tags['addr:full']) return tags['addr:full'];
            
            // Build address from components
            if (tags['addr:housenumber']) addressParts.push(tags['addr:housenumber']);
            if (tags['addr:street']) addressParts.push(tags['addr:street']);
            if (tags['addr:city'] || tags['addr:town'] || tags['addr:village']) {
                addressParts.push(tags['addr:city'] || tags['addr:town'] || tags['addr:village']);
            }
            if (tags['addr:postcode']) addressParts.push(tags['addr:postcode']);
            
            // If no address parts, try the "addr" tag
            if (addressParts.length === 0 && tags.addr) return tags.addr;
            
            // If still no address, use a default message
            return addressParts.length > 0 ? addressParts.join(', ') : 'Address not available';
        }
        
        // Get human-readable facility type
        function getFacilityTypeText(tags) {
            if (tags.amenity === 'hospital') return 'Hospital';
            if (tags.amenity === 'clinic') return 'Clinic';
            if (tags.amenity === 'doctors' || tags.healthcare === 'doctor') return 'Doctor\'s Office';
            if (tags.amenity === 'pharmacy') return 'Pharmacy';
            if (tags.healthcare === 'hospital') return 'Hospital';
            if (tags.healthcare === 'clinic') return 'Clinic';
            if (tags.healthcare) return `Healthcare: ${tags.healthcare}`;
            return 'Healthcare Facility';
        }
        
        // Add a marker for a facility
        function addFacilityMarker(lat, lon, name, type, id) {
            let iconUrl;
            
            // Choose icon based on facility type
            if (type.includes('Hospital')) {
                iconUrl = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="%23e53e3e" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg>';
            } else if (type.includes('Pharmacy')) {
                iconUrl = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="%2338a169" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14h-2V15h-2v-2h2V9h2v4h4v2h-4v4z"/></svg>';
            } else if (type.includes('Clinic')) {
                iconUrl = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="%233182ce" d="M21 5h-2.64l1.14-3.14L17.5 1l-1.5 4H3v2l2 6-2 6v2h18v-2l-2-6 2-6V5zm-3.9 8.63L16.9 14l.9-2.5 2.2-1.63-2.2-1.62-.9-2.5-.8-.37-1.9 1.12h-2.5l-1.9-1.12-.8.37-.9 2.5-2.2 1.62 2.2 1.63.9 2.5.8.37 1.9-1.12h2.5l1.9 1.12.8-.37z"/></svg>';
            } else {
                iconUrl = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="%234299e1" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14h-2V9h-2V7h6v2h-2v8z"/></svg>';
            }
            
            // Create icon
            const facilityIcon = L.icon({
                iconUrl: iconUrl,
                iconSize: [36, 36],
                iconAnchor: [18, 36],
                popupAnchor: [0, -36]
            });
            
            // Create marker
            const marker = L.marker([lat, lon], {
                icon: facilityIcon,
                facilityId: id
            }).addTo(map);
            
            // Add popup
            marker.bindPopup(`
                <div style="min-width: 200px;">
                    <h3 style="margin: 0 0 5px 0; font-size: 16px;">${name}</h3>
                    <p style="margin: 0 0 5px 0; font-size: 12px;">${type}</p>
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}" 
                       target="_blank" 
                       style="display: inline-block; padding: 5px 10px; background-color: #4263eb; color: white; text-decoration: none; border-radius: 3px; font-size: 12px;">
                        Get Directions
                    </a>
                </div>
            `);
            
            // Add click handler
            marker.on('click', function() {
                highlightFacility(id);
            });
            
            // Store marker for later reference
            facilityMarkers.push(marker);
        }
        
        // Clear all facility markers from map
        function clearFacilityMarkers() {
            facilityMarkers.forEach(marker => {
                map.removeLayer(marker);
            });
            facilityMarkers = [];
        }
        
        // Highlight a facility on the map and in the list
        function highlightFacility(id) {
            // Highlight marker
            facilityMarkers.forEach(marker => {
                if (marker.options.facilityId === id) {
                    marker.openPopup();
                    
                    // Pan map to this marker
                    map.panTo(marker.getLatLng());
                }
            });
            
            // Highlight list item
            document.querySelectorAll('.location-card').forEach(card => {
                card.classList.remove('active');
                if (parseInt(card.dataset.id) === id) {
                    card.classList.add('active');
                    card.scrollIntoView({behavior: 'smooth', block: 'nearest'});
                }
            });
        }
        
        // Select a popular city and update the search form
        function selectCity(city) {
            // Update the location input with the city name
            document.getElementById('location-input').value = city;
            
            // Optionally, you can trigger the search automatically
            document.getElementById('search-form').dispatchEvent(new Event('submit'));
        }
    </script>
</body>
</html>